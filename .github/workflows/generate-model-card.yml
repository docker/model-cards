name: Generate Model Card

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Docker Hub namespace (default: "aistaging")'
        required: false
        default: 'aistaging'
        type: string
      repository:
        description: 'Docker Hub repository name (e.g., "qwen3")'
        required: true
        type: string
      reference_urls:
        description: 'Comma-separated reference URLs (HuggingFace pages, blog posts, papers, etc.)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      # ============================================================================
      # STEP 1: Generate the model card
      # ============================================================================

      - name: Generate model card
        uses: docker/cagent-action@bd5439a1cabc3c448abf7a0d29b6f9a0d5fd4ec7
        with:
          agent: .github/agents/model-card-generator.yaml
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            **Repository:** ${{ inputs.namespace }}/${{ inputs.repository }}
            **Model name:** ${{ inputs.repository }}
            **Reference URLs to research:**
            ${{ inputs.reference_urls }}

      - name: Verify model card was generated
        run: |
          if [ ! -f "${{ inputs.namespace }}/${{ inputs.repository }}.md" ]; then
            echo "::error::Model card file was not generated at ${{ inputs.namespace }}/${{ inputs.repository }}.md"
            exit 1
          fi
          echo "âœ… Model card generated successfully:"
          head -20 "${{ inputs.namespace }}/${{ inputs.repository }}.md"

      # ============================================================================
      # STEP 2: Generate short description using agent
      # ============================================================================

      - name: Generate short description
        uses: docker/cagent-action@bd5439a1cabc3c448abf7a0d29b6f9a0d5fd4ec7
        with:
          agent: .github/agents/short-description-generator.yaml
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Read the model card at: ${{ inputs.namespace }}/${{ inputs.repository }}.md
            Write the short description to: short-description.txt

      - name: Verify short description was generated
        run: |
          if [ ! -f "short-description.txt" ]; then
            echo "::error::Short description file was not generated"
            exit 1
          fi
          SHORT_DESC=$(cat short-description.txt)
          echo "âœ… Short description generated: ${SHORT_DESC}"
          echo "ðŸ“ Length: ${#SHORT_DESC} chars"

      # ============================================================================
      # STEP 3: Resolve logo using agent
      # ============================================================================

      - name: Resolve logo
        uses: docker/cagent-action@bd5439a1cabc3c448abf7a0d29b6f9a0d5fd4ec7
        with:
          agent: .github/agents/logo-resolver.yaml
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Find the best matching logo for repository: ${{ inputs.repository }}
            Write the result to: logo-match.txt

      - name: Show resolved logo
        run: |
          if [ -f "logo-match.txt" ]; then
            LOGO=$(cat logo-match.txt)
            echo "ðŸŽ¨ Logo resolved: ${LOGO}"
          else
            echo "âš ï¸  No logo-match.txt generated â€” logo upload will be skipped"
          fi

      # ============================================================================
      # STEP 4: Push description and logo to Docker Hub
      # ============================================================================

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Get Docker Hub token
        id: hub-token
        env:
          HUB_USER: ${{ secrets.HUB_USER }}
          HUB_PAT: ${{ secrets.HUB_PAT }}
        run: |
          TOKEN=$(python3 scripts/get_docker_hub_token.py)
          if [ $? -ne 0 ] || [ -z "$TOKEN" ]; then
            echo "::error::Failed to get Docker Hub token"
            exit 1
          fi
          echo "::add-mask::${TOKEN}"
          echo "token=${TOKEN}" >> $GITHUB_OUTPUT
          echo "âœ… Docker Hub token obtained"

      - name: Push description to Docker Hub
        env:
          DOCKER_HUB_TOKEN: ${{ steps.hub-token.outputs.token }}
        run: |
          python3 scripts/upload_description.py \
            "${{ inputs.namespace }}" \
            "${{ inputs.repository }}" \
            "${{ inputs.namespace }}/${{ inputs.repository }}.md" \
            "short-description.txt"

      - name: Push logo to Docker Hub
        env:
          DOCKER_HUB_TOKEN: ${{ steps.hub-token.outputs.token }}
        run: |
          python3 scripts/upload_logo.py \
            "${{ inputs.namespace }}" \
            "${{ inputs.repository }}" \
            "logo-match.txt"

      # ============================================================================
      # STEP 5: Create Pull Request
      # ============================================================================

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add model card for ${{ inputs.namespace }}/${{ inputs.repository }}"
          title: "Add model card for ${{ inputs.namespace }}/${{ inputs.repository }}"
          body: |
            ## ðŸ¤– Auto-generated Model Card

            This PR adds a model card for **${{ inputs.namespace }}/${{ inputs.repository }}**.

            ### Reference URLs used
            ${{ inputs.reference_urls }}

            ### Docker Hub
            The description and logo have been pushed to Docker Hub:
            ðŸ”— https://hub.docker.com/r/${{ inputs.namespace }}/${{ inputs.repository }}

            ### Generated by
            This model card was automatically generated using [cagent-action](https://github.com/docker/cagent-action) with the [Docker Model Runner's model-card-generator](https://github.com/docker/model-cards).

            ---
            Please review the generated content for accuracy before merging.
          branch: adds-model-card-${{ inputs.namespace }}-${{ inputs.repository }}
          base: main
          labels: model-card,automated
          delete-branch: true
          add-paths: ${{ inputs.namespace }}/${{ inputs.repository }}.md
